{{extend 'layout.html'}}
<script type="text/javascript" src="/{{=request.application}}/static/js/ui/jquery.ui.core.js"></script> 
<script type="text/javascript" src="/{{=request.application}}/static/js/date.format.js"></script> 
<script type="text/javascript" src="/{{=request.application}}/static/js/ui/jquery.ui.widget.js"></script> 
<script type="text/javascript" src="/{{=request.application}}/static/js/ui/jquery.ui.tabs.js"></script> 

<link rel="stylesheet" href="/{{=request.application}}/static/js/themes/base/jquery.ui.all.css"> 
<script>

$(function(){
    $('input[name^=s_]').keyup(function() {
        list = $('.messages');
    
        var text1 = $('input[name=s_user]').val().toLowerCase();
        if (text1 != '') var pattern1 = new RegExp('^.*' + text1 + '.*$', 'ig');
        else var pattern1 = new RegExp('.*', 'ig');
        
        var text2 = $('input[name=s_subject]').val().toLowerCase();
        if (text2 != '') var pattern2 = new RegExp('^.*' + text2 + '.*$', 'ig');
        else var pattern2 = new RegExp('.*', 'ig');        
        
        var text3 = $('input[name=s_tag]').val().toLowerCase();
        if (text3 != '') var pattern3 = new RegExp('^.*' + text3 + '.*$', 'ig');
        else var pattern3 = new RegExp('.*', 'ig');
        
        $.each(list, function(index,value){
            message = $(this).children().eq(2).text()
            
            tags = ''
            if (message.lastIndexOf(']') != -1){
                tags = message.substring(0,message.lastIndexOf(']'))
                message = message.substring(message.lastIndexOf(']') + 1)
            }
                    
            if ($(this).children().eq(1).text().match(pattern1) && message.match(pattern2) && tags.match(pattern3))
                $(this).show() 
            else $(this).hide()        
        })
    })

    $('tr.messages').live('click', function(){
        window.location.replace('/msghandler/default/read_message/' + $(this).children().first().text());
    });

    $('img.delete').one('click', function(){
        var answer = confirm('Are you sure you want to delete this?')
        if (answer){
            $(this).parent().fadeOut( function() { $(this).remove();});
            $.ajax({
                url: '{{=URL('delete_ajax_id')}}',
                data: 'id=' + this.id,
                success: function(msg){
                    $('.flash').html(msg).slideDown(function(){ $('.flash').delay(3000).fadeOut(function(){$('.flash').html('')});});
                }                
            })             
        } 
    })
    $('.top-td').live('mouseenter', function(){$($(this).children()[1]).show();})
    $('.top-td').live('mouseleave', function(){$($(this).children()[1]).hide();});

});     
</script>
<style>
.menu { border: 1px solid black}
tr.messages:hover{background: lightgray;}
input[name^=s_]{width:150px}
</style>
Things to Do
<ol>
<li><del>Make messages clickable.</del></li>
<li><del>Add Tags in messages in the list</del></li>
<li>Layout</li>
<li><del>Remove/hide comments in list of messages (parent_msg = 0 instead those with subject Re:)</del></li>
<li><del>Change background during hover in messages.</del></li>
<li>Added Search using ajax</li>

<li></li>
</ol>

<table width='100%'>
    <tr>
        <td width="15%">Logo</td>
        
        <td>{{=TABLE(TR(LABEL('Search: '),INPUT(_name='s_user', _placeholder='search by author'),INPUT(_name='s_subject', _placeholder='search by subject'),INPUT(_name='s_tag', _placeholder='search by tag'),TD(TAG.BUTTON('Clear search fields',_onclick="$('[name^=s_]').val('');$('[name^=s_]').keyup();"), _width='20%'),_width='100%'))}}
</td>
    </tr>
    <tr>
        <td width="15%" class='menu'>
            <table class='menu_table' width='100%'>
                <tr><td><input type="button" width='100%' value='    Compose    ' onclick='window.open("/msghandler/default/create_message");'></input></td></tr>
                <tr><td>Late</td></tr>
                <tr><td>Inbox</td></tr>
                <tr><td>Drafts</td></tr>
                <tr><td>Sent</td></tr>
                <tr><td>Trash</td></tr>
                <tr><td><hr/></td></tr>
                <tr><td>Groups</td></tr>
                {{if len(my_roles):}}
                    {{groups_dict = dict()}}
                    {{for role in my_roles:}}
                    <tr>
                        <td>
                            {{=LI(role.group_id.role)}}
                            {{groups_dict[role.group_id.role] = []}}
                        </td>
                    </tr>
                    {{pass}}                
                {{pass}}
            </table>        
        </td>
        <td class='menu'>
            <table width='100%' id='list'>
                <tr style="font-weight:bold;" id='message-hdr'>
                    <td>Created by</td>
                    <td>Subject</td>
                    <td>Timestamp</td>
                </tr>
                {{if len(msgs):}}
                    {{for message in msgs:}}
                        <tr class='messages'>
                            <td style='display: none;'>{{=message['id']}}</td>
                            <td width='20%'>{{=message['by']}}</td>
                            <td>{{=message['tags'] + message['subject']}}</td>
                            <td width='20%'>{{=message['time']}}</td>
                        </tr>
                    {{pass}}
                {{pass}}            
            </table>
        </td>
    </tr>
    
</table>
<h1>My Groups</h1>
{{if len(my_roles):}}
{{groups_dict = dict()}}
<ul>{{for role in my_roles:}}
        {{=LI(role.group_id.role)}}
        {{groups_dict[role.group_id.role] = []}}
    {{pass}}
</ul>
{{else:}}{{=I('You have no groups.')}}{{pass}}

<h1>Users</h1>
{{if len(users):}}
[{{=A('Create a new user', _href=URL('create_user'))}}]<br />
<ul>{{for user in users:}}
        {{if isAdmin:}}
            {{=LI(A(user.first_name + ' ' +user.last_name, _href=URL('show_user',args=user.id)),
                IMG(_src=URL('static', 'images/delete.png'), _class='delete', _hidden='true', _id='auth_user-' + `user.id`), _class='top-td' )}}
        {{else:}}
            {{=LI(A(user.first_name + ' ' +user.last_name, _href=URL('show_user',args=user.id)))}}
        {{pass}}
    {{pass}}
</ul>
{{else:}}{{=I('There are no users.')}}{{pass}}

{{if isAdmin or isTelehealth:}}
<h1>Contacts</h1>
{{if len(contacts):}}
[{{=A('Create a new contact', _href=URL('data', args=('create', 'contact')))}}]<br />
<ul>{{for contact in contacts:}}
        {{if isAdmin:}}
            {{=LI(A(contact.name, _href=URL('data', args=('update', 'contact', contact.id))), 
                IMG(_src=URL('static', 'images/delete.png'), _class='delete', _hidden='true', _id='contact-' + `contact.id`), _class='top-td' )}}
        {{else:}}
            {{=LI(A(contact.name, _href=URL('data', args=('update', 'contact', contact.id))))}}
        {{pass}}
    {{pass}}
</ul>
{{else:}}{{=I('There are no contacts.')}}{{pass}}
{{pass}}

{{if len(groups):}}
<h1>Groups</h1>
[{{=A('Create a new group', _href=URL('data', args=('create','auth_group')))}}]<br />
<ul>{{for group in groups:}}
        {{if isAdmin:}}
        {{=LI(A(group.role, _href=URL('data', args=('update', 'auth_group', group.id))),
            IMG(_src=URL('static', 'images/delete.png'), _class='delete', _hidden='true', _id='auth_group-' + `group.id`), _class='top-td' )}}
        {{else:}}{{=LI(A(group.role, _href=URL('data', args=('update', 'auth_group', group.id))))}}
        {{pass}}
    {{pass}}
</ul>
{{pass}}

{{if isAdmin or isTelehealth:}}
<h1>Tags</h1>
{{if len(tags):}}
{{if isAdmin:}}
[{{=A('Create a new tag', _href=URL('data', args=('create', 'tag')))}}]<br />{{pass}}
<ul>{{for tag in tags:}}
        {{if isAdmin:}}
            {{=LI(A(tag.name, _href=URL('data', args=('update', 'tag', tag.id))),
                IMG(_src=URL('static', 'images/delete.png'), _class='delete', _hidden='true', _id='tag-' + `tag.id`), _class='top-td' )}}
        {{else:}}{{=LI(tag.name)}}
        {{pass}}
    {{pass}}
</ul>
{{else:}}{{=I('There are no tags.')}}{{pass}}
{{pass}}

<h1>Messages</h1>
{{created = []}}
{{ungrouped = []}}
{{assigned = []}}
{{grouped = []}}
[{{=A('Create a new message', _href=URL('create_message'))}}]<br />
{{if len(messages):}}
<ul>{{for message in messages:}}
        {{if isAdmin:}}
            {{li=LI(SPAN(A(message.subject, _href=URL('show_message',args=message.id)), ' by ', A(message.created_by.name, _href=URL('show_contact', args=message.created_by.id))),IMG(_src=URL('static', 'images/delete.png'), _class='delete', _hidden='true', _id='msg-' + `message.id`), _class='top-td')}}
            {{if message.created_by == contact_id:}}{{created.append(li)}}
            {{pass}}
            {{if len(msg_group.find(lambda row: row.assigned_by == auth.user.id and row.msg_id == message.id)):}}            
                {{assigned.append(li)}}
            {{elif len(msg_group.find(lambda row: row.msg_id == message.id)) == 0:}}                
                {{ungrouped.append(li)}}            
            {{else:}}{{grouped.append(li)}}            
            {{pass}}            
        {{elif isTelehealth:}}
            {{if message.created_by == contact_id:}}                
                {{li = LI(SPAN(A(message.subject, _href=URL('show_message',args=message.id)), ' by ', A(message.created_by.name, _href=URL('show_contact', args=message.created_by.id))),IMG(_src=URL('static', 'images/delete.png'), _class='delete', _hidden='true', _id='msg-' + `message.id`), _class='top-td')}}
                {{created.append(li)}}
            {{pass}}
            {{if len(msg_group.find(lambda row: row.assigned_by == auth.user.id and row.msg_id == message.id)):}}                        
                {{li =LI(SPAN(A(message.subject, _href=URL('show_message',args=message.id)), ' by ', A(message.created_by.name, _href=URL('show_contact', args=message.created_by.id))), _class='top-td')}}
                {{assigned.append(li)}}                
            {{else:}}  
                {{li =LI(SPAN(A(message.subject, _href=URL('show_message',args=message.id)), ' by ', A(message.created_by.name, _href=URL('show_contact', args=message.created_by.id))), _class='top-td')}}
                {{ungrouped.append(li)}}            
            {{pass}}
        {{else:}}
            {{if message.created_by == contact_id:}}                
                {{li = LI(SPAN(A(message.subject, _href=URL('show_message',args=message.id)), ' by ', A(message.created_by.name, _href=URL('show_contact', args=message.created_by.id))),IMG(_src=URL('static', 'images/delete.png'), _class='delete', _hidden='true', _id='msg-' + `message.id`), _class='top-td')}}
                {{created.append(li)}}
            {{pass}}
            {{group_msgs = msg_group.find(lambda row: row.msg_id == message.id)}}
            {{for msg in group_msgs:}}
                {{li =LI(SPAN(A(message.subject, _href=URL('show_message',args=message.id)), ' by ', A(message.created_by.name, _href=URL('show_contact', args=message.created_by.id))), _class='top-td')}}
                {{groups_dict[msg.group_id.role].append(li)}}            
            {{pass}}

        {{pass}}
    {{pass}}
    
    {{if len(created):}}
        <li><h4>Messages you created</h4></li>
        {{=UL(*created)}}        
    {{pass}}
    {{if len(assigned):}}
        <li><h4>Messages that you have assigned</h4></li>
        {{=UL(*assigned)}}        
    {{pass}}
    
    {{if len(ungrouped):}}
        <li><h4>Messages that have no groups</h4></li>
        {{=UL(*ungrouped)}}        
    {{pass}}

    {{if isAdmin or isTelehealth:}}
        {{if len(grouped):}}
            <li><h4>Messages that have groups</h4></li>
            {{=UL(*grouped)}}        
        {{pass}}
    {{else:}}
        {{for key in groups_dict.keys():}}
            <li><h4>{{=key}}</h4></li>
            {{=UL(*groups_dict[key])}}
        {{pass}}
    {{pass}}
</ul>
{{else:}}{{=I('There are no messages.')}}{{pass}}
