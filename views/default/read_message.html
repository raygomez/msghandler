{{extend 'layout.html'}}
<script type="text/javascript" src="/{{=request.application}}/static/js/jquery.timeago.js"></script>
<script src="{{=URL('static','js/tagging_ajax.js')}}"></script>
<script src="{{=URL('static','js/grouping_ajax.js')}}"></script>
{{=json}}
<script>
var msg_id = {{=id}};

$(function(){
    
    $('.timestamp').timeago()

    click_once_tag();            
    click_once_group();            
})

function addgroups(widget){    
    groups = $.grep(groups, function(group){ return group.role != widget.target.name } )
    
    $.ajax({
        url: '/msghandler/default/insert_ajax',
        data: 'group=' + this.id  + '&id=' + msg_id + '&table=msg_group'
        })             
    
    td1 = $('<img>').attr({
            src:'/msghandler/static/images/delete.png',
            class:'groups-add',
            hidden:true,
            name:widget.target.name,
            id: 'img' + widget.target.id,
        });

    $(widget.target).parent().fadeOut(function() { $(this).remove(); });
    $('#tr-groups-new table tr').append($('<td class="top-td">').append($('<span>'+ widget.target.name +'</span>'),td1));
    
    $('.groups-add').unbind();
    click_once_group();
}

function click_once_group(){
    $('.groups-add').one('click', function(){
        $(this).parent().fadeOut( function() { $(this).remove();});
        id = parseInt(this.id.split('imgt')[1]);
        tag = {id:id, role:this.name};
        groups.push(tag); 
        $.ajax({
            url: '/msghandler/default/delete_ajax',
            data: 'group=' + id  + '&id=' + msg_id + '&table=msg_group'
        })             
        showgroups();                 
    });
}
</script>
<style>
.td_img {text-align:center;}
</style>

Things to Do
<ol>
<li>Reply Message, I think this is already done.</li>
<li><del>Add attachment details (timestamp, creator, etc?)</del></li>
<li><del>Attachment preview (or at least placeholder). by filetype, if possible.</del></li>
<li>Layout</li>
<li></li>
</ol>

<style>
tr.content,tr.attachment { 
    border: 1px solid black;
    width: 95%;
}
</style>

REFERRAL
<table width='95%'>
<tr><td><h4>{{=message.subject}}</h4></td><tr/>
<tr>
    <td>From:{{=message.created_by.name}} ({{=SPAN(_title=message.create_time,_class='timestamp')}}) | {{=A('Remove referral', _href='#')}}</td></tr>
{{if update_time:}}
<tr><td>Updated {{=SPAN(_title=update_time,_class='timestamp')}}</td></tr>
{{pass}}
<tr class='content'><td>{{=message.content}}</td></tr>
<tr><td><br/></td></td>
<tr>
<table>
<tr><td width='15%'>Groups:</td>
    <td>{{=INPUT(_placeholder='search groups',_name='groups', _onkeyup='showgroups()', _autocomplete='off' )}}</td>
    <td id='tr-groups-new'><table><tr>
{{if len(groups):}}    
    {{for group in groups:}}
        <td class='top-td'>
            <span>{{=group.group_id.role}}</span>
            {{=IMG(_src=URL('static', 'images/delete.png'), _hidden=True, _class='groups-add', _id='imgt'+ `group.group_id.id`, _name=group.group_id.role)}}
        </td>
    {{pass}}
{{pass}}    
    </tr></table></td>
</tr>    
<tr><td></td><td><div id='new-groups'></div></td><tr>

<tr><td>Tags:</td>
    <td>{{=INPUT(_placeholder='search tags', _name='tags', _onkeyup='showtags()', _autocomplete='off')}}</td>
    <td id='tr-tags-new'><table><tr>
{{if len(tags):}}    
    {{for tag in tags:}}
        <td class='top-td'>
            <span>{{=tag.tag_id.name}}</span>
            {{=IMG(_src=URL('static', 'images/delete.png'), _hidden=True, _class='tags-add', _id='imgt'+ `tag.tag_id.id`, _name=tag.tag_id.name)}}
        </td>
    {{pass}}
{{pass}}    
    </tr></table></td>
</tr>
<tr><td></td><td><div id='new-tags'></div></td><tr>
</tr>
</table>
<br/>
</table>
ATTACHMENTS | {{=A('Upload new attachments', _href=URL('create_attachment', args=id))}}<br />
{{if len(attachs) > 0:}}
<table id='attachments' width=95%>
{{for attach in attachs:}}

<tr class='attachment'>
{{=TD(A(IMG(_src=attach['src'], _alt="attachments", _height='50px'),
      _href=URL('download',args=attach['attachment'].attachment)), _class='td_img')}}
{{=TD(attach['attachment'].filename,' | ',A('Remove this attachment', _href='#'),BR(),'added by ', SPAN(attach['attachment'].attach_by.name,' ', SPAN(_title=attach['attachment'].attach_time,_class='timestamp') ))}}
</tr>
{{pass}}
</table>
{{pass}}
<br/>
REPLIES
<table width=95%>
{{for reply in replies:}}
<tr><td>From {{=reply.created_by.name}} {{=SPAN(_title=reply.create_time,_class='timestamp')}} | {{=A('Remove reply', _href='#')}}</td></tr>
<tr class='content'><td colspan=2>{{=reply.content}}</td></tr>
{{pass}}
{{=form}}
</table>
