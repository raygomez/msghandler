{{extend 'layout.html'}}
<script type="text/javascript" src="/{{=request.application}}/static/js/jquery.timeago.js"></script>
<script>
    $(function(){
        $('.timestamp').timeago()             
    })
</script>
Things to Do
<ol>
<li>users can view own events</li>
<li>users can view events from a referral where they commented (or where they are creator)</li>
<li>users can view new message events from a group where they are member of</li>
<li><del>CUD Tag</del></li>
<li><del>CUD Group</del></li>
<li><del>CUD Contact</del></li>
<li><del>C Message</del></li>
<li><del>CUD User</del></li>
<li><del>CD msg_tag</del></li>
<li><del>CD msg_group<del></li>
<li><del>CD auth_membership<del></li>
<li><del>C Replies</del></li>
<li><del>C Attachments</del></li>
<li><li>
<li>filter by access</li>
<li>filter by table</li>
</ol>
Sample events
<ol>
<li><a href="#">Jose Rizal</a> sent an <a href="#">email referral</a>. <abbr href="#" class="timestamp" title="2011-05-22T09:24:17Z" /></li>
<li><a href="#">Jose Rizal</a> sent an <a href="#">SMS reply</a>. <abbr href="#" class="timestamp" title="2008-07-17T09:24:17Z" /></li>
<li>(kaya lang mukhang mahirap isama sa ordering) <a href="#">Jose Rizal</a> sent an <a href="#">SMS reply</a> to <a href="#">Andres Bonifacio's</a> <a href="#">SMS referral</a>. <abbr href="#" class="timestamp" title="2008-07-17T09:24:17Z" /></li>
<li><a href="#">Jose Rizal</a> created new tag <a href="#">Telehealth</a>. <abbr href="#" class="timestamp" title="2008-07-17T09:24:17Z" /></li>
<li><a href="#">You</a> deleted tag <a href="#">Admin</a>. <abbr href="#" class="timestamp" title="2008-07-17T09:24:17Z" /></li>
<li><a href="#">Jose Rizal</a> modified tag <a href="#">Telehealth</a>. <abbr href="#" class="timestamp" title="2008-07-17T09:24:17Z" /></li>
<li><a href="#">You</a> deleted tag <a href="#">Admin</a>. <abbr href="#" class="timestamp" title="2008-07-17T09:24:17Z" /></li>
<li></li>
</ol>

<table>
{{for evnt in evnts:}}

{{if evnt['table'] == 'tag':}}
    {{if evnt['access'] == 'create':}}
        <tr><td>{{=evnt['user']}} added a new tag {{=A(evnt['item'].name, _href=URL('tags')) if evnt['item'] else evnt['details'] + ' ' + '[was deleted]'}}. <span class='timestamp' title={{=evnt['timestamp'].isoformat()}}></span></td></tr>
    {{elif evnt['access'] == 'update':}}
        <tr><td>{{=evnt['user']}} updated the tag {{=A(evnt['item'].name, _href=URL('tags')) if evnt['item'] else '[was deleted]'}} [{{=evnt['details']}}]. <span class='timestamp' title={{=evnt['timestamp'].isoformat()}}></span> </td></tr>
        {{elif evnt['access'] == 'delete':}}
<tr><td>{{=evnt['user']}} deleted the tag {{=evnt['details']}}. <span class='timestamp' title={{=evnt['timestamp'].isoformat()}}></span> </td>
    {{pass}}

{{elif evnt['table'] == 'auth_group':}}
    {{if evnt['access'] == 'create':}}
        <tr><td>{{=evnt['user']}} added a new group {{=A(evnt['item'].role, _href=URL('groups')) if evnt['item'] else evnt['details'] + ' ' + '[was deleted]'}}. <span class='timestamp' title={{=evnt['timestamp'].isoformat()}}></span></td></tr>
    {{elif evnt['access'] == 'update':}}
        <tr><td>{{=evnt['user']}} updated the group {{=A(evnt['item'].role, _href=URL('groups')) if evnt['item'] else '[was deleted]'}} [{{=evnt['details']}}]. <span class='timestamp' title={{=evnt['timestamp'].isoformat()}}></span> </td></tr>
    {{elif evnt['access'] == 'delete':}}
        <tr><td>{{=evnt['user']}} deleted the group {{=evnt['details']}}. <span class='timestamp' title={{=evnt['timestamp'].isoformat()}}></span> </td>
    {{pass}}

{{elif evnt['table'] == 'contact':}}
    {{if evnt['access'] == 'create':}}
        <tr><td>{{=evnt['user']}} added a new contact {{=A(evnt['item'].name, _href=URL('contacts')) if evnt['item'] else '[was deleted]'}}. <span class='timestamp' title={{=evnt['timestamp'].isoformat()}}></span></td></tr>
    {{elif evnt['access'] == 'update':}}
        <tr><td>{{=evnt['user']}} updated the contact {{=A(evnt['item'].name, _href=URL('contacts')) if evnt['item'] else '[was deleted]'}} [{{=evnt['details']}}]. <span class='timestamp' title={{=evnt['timestamp'].isoformat()}}></span> </td></tr>
    {{elif evnt['access'] == 'delete':}}
        <tr><td>{{=evnt['user']}} deleted the contact {{=evnt['details']}}. <span class='timestamp' title={{=evnt['timestamp'].isoformat()}}></span> </td>
    {{pass}}

{{elif evnt['table'] == 'auth_user':}}
    {{if evnt['access'] == 'create':}}
        <tr><td>{{=evnt['user']}} added a new user {{=A(evnt['item'].email, _href=URL('show_user', args=evnt['item'].id)) if evnt['item'] else '[was deleted]'}}. <span class='timestamp' title={{=evnt['timestamp'].isoformat()}}></span></td></tr>
    {{elif evnt['access'] == 'update':}}
        <tr><td>{{=evnt['user']}} updated the user {{=A(evnt['item'].email, _href=URL('show_user'), args=evnt['item'].id) if evnt['item'] else '[was deleted]'}} [{{=evnt['details']}}]. <span class='timestamp' title={{=evnt['timestamp'].isoformat()}}></span> </td></tr>
    {{elif evnt['access'] == 'delete':}}
        <tr><td>{{=evnt['user']}} deleted the user {{=evnt['details']}}. <span class='timestamp' title={{=evnt['timestamp'].isoformat()}}></span> </td>
    {{pass}}

{{elif evnt['table'] == 'msg':}}
    {{if evnt['access'] == 'create':}}
        {{if evnt['item'].parent_msg == 0:}}
            <tr><td>{{=evnt['user']}} added a new message {{=A(evnt['item'].subject, _href=URL('read_message', args=evnt['item'].id))}}. <span class='timestamp' title={{=evnt['timestamp'].isoformat()}}></span></td></tr>
        {{else:}}    
            <tr><td>{{=evnt['user']}} replied to the message {{=A(evnt['item'].parent_msg.subject, _href=URL('read_message', args=evnt['item'].parent_msg.id))}} by {{=evnt['item'].parent_msg.created_by.name}}. <span class='timestamp' title={{=evnt['timestamp'].isoformat()}}></span></td></tr>        
        {{pass}}
    {{pass}}

{{elif evnt['table'] == 'msg_tag':}}
    {{if evnt['access'] == 'create':}}
        {{if evnt['item']:}}
            <tr><td>{{=evnt['user']}} tagged the message {{=A(evnt['item'].msg_id.subject, _href=URL('read_message', args=evnt['item'].id))}} as {{=A(evnt['item'].tag_id.name, _href=URL('tags'))}} . <span class='timestamp' title={{=evnt['timestamp'].isoformat()}}></span></td></tr>
        {{else:}}
            {{tag = evnt['details'].split(',')[1]}}
            {{subject,msg_id = evnt['details'].split(',')[0],evnt['details'].split(',')[2]}}
            <tr><td>{{=evnt['user']}} tagged the message {{=A(subject,_href=URL('read_message', args=msg_id))}} as {{=A(tag, _href=URL('tags'))}} [Already removed]. <span class='timestamp' title={{=evnt['timestamp'].isoformat()}}></span></td></tr>
        {{pass}}
    {{elif evnt['access'] == 'delete':}}
        {{tag = evnt['details'].split(',')[1]}}
        {{subject,msg_id = evnt['details'].split(',')[0],evnt['details'].split(',')[2]}}
        <tr><td>{{=evnt['user']}} removed the tag {{=A(tag, _href=URL('tags'))}} in the message {{=A(subject,_href=URL('read_message', args=msg_id))}}. <span class='timestamp' title={{=evnt['timestamp'].isoformat()}}></span></td></tr>
        
    {{pass}}    

{{elif evnt['table'] == 'msg_group':}}
    {{if evnt['access'] == 'create':}}
        {{if evnt['item']:}}
            <tr><td>{{=evnt['user']}} grouped the message {{=A(evnt['item'].msg_id.subject, _href=URL('read_message', args=evnt['item'].id))}} to {{=A(evnt['item'].group_id.role, _href=URL('groups'))}}. <span class='timestamp' title={{=evnt['timestamp'].isoformat()}}></span></td></tr>
        {{else:}}
            {{group = evnt['details'].split(',')[1]}}
            {{subject,msg_id = evnt['details'].split(',')[0],evnt['details'].split(',')[2]}}
            <tr><td>{{=evnt['user']}} grouped the message {{=A(subject,_href=URL('read_message', args=msg_id))}} to {{=A(group, _href=URL('groups'))}} [Already removed]. <span class='timestamp' title={{=evnt['timestamp'].isoformat()}}></span></td></tr>
        {{pass}}
    {{elif evnt['access'] == 'delete':}}
        {{group = evnt['details'].split(',')[1]}}
        {{subject,msg_id = evnt['details'].split(',')[0],evnt['details'].split(',')[2]}}
        <tr><td>{{=evnt['user']}} removed the message {{=A(subject,_href=URL('read_message', args=msg_id))}} from the {{=A(group, _href='groups')}} group. <span class='timestamp' title={{=evnt['timestamp'].isoformat()}}></span></td></tr>
        
    {{pass}}    

{{elif evnt['table'] == 'auth_membership':}}
    {{group = evnt['details'].split(',')[1]}}
    {{email,user_id = evnt['details'].split(',')[0],evnt['details'].split(',')[2]}}

    {{if evnt['access'] == 'create':}}
        {{if evnt['item']:}}
            <tr><td>{{=evnt['user']}} added the user {{=A(evnt['item'].user_id.email, _href=URL('show_user', args=evnt['item'].user_id.id))}} to {{=A(evnt['item'].group_id.role, _href=URL('groups'))}}. <span class='timestamp' title={{=evnt['timestamp'].isoformat()}}></span></td></tr>
        {{else:}}
            <tr><td>{{=evnt['user']}} added the user {{=A(email, _href=URL('show_user', args=user_id))}} to {{=A(group, _href=URL('groups'))}} [Already removed]. <span class='timestamp' title={{=evnt['timestamp'].isoformat()}}></span></td></tr>
        {{pass}}
    {{elif evnt['access'] == 'delete':}}
        {{group = evnt['details'].split(',')[1]}}
        {{email,user_id = evnt['details'].split(',')[0],evnt['details'].split(',')[2]}}
        <tr><td>{{=evnt['user']}} removed the user {{=A(email, _href=URL('show_user', args=user_id))}} from the {{=A(group, _href='groups')}} group. <span class='timestamp' title={{=evnt['timestamp'].isoformat()}}></span></td></tr>        
    {{pass}}    

{{elif evnt['table'] == 'msg_attachment':}}
    {{filename = evnt['details'].split(',')[1]}}
    {{subject,msg_id = evnt['details'].split(',')[0],evnt['details'].split(',')[2]}}

    {{if evnt['access'] == 'create':}}
        {{if evnt['item']:}}
            <tr><td>{{=evnt['user']}} attach the file {{=A(filename, _href=URL('download', args=evnt['item'].attachment))}} to the message  {{=A(evnt['item'].msg_id.subject, _href=URL('read_message', args=msg_id))}} by {{=evnt['item'].msg_id.created_by.name}}. <span class='timestamp' title={{=evnt['timestamp'].isoformat()}}></span></td></tr>
            {{pass}}
    {{pass}}    
{{pass}}
{{pass}}
</table>
