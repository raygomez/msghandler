{{extend 'layout.html'}}
<script src="{{=URL('static','js/jquery.autocomplete.js')}}"></script>
<link rel="stylesheet" href="{{=URL('static','css/jquery.autocomplete.css')}}">
{{=form}}
{{=json}}
<script>

function addtags(widget){    

    
    
    tags = $.grep(tags, function(tag){ return tag.id != parseInt(widget.target.id.split('t')[1])});
    //td = $('<td>').append($('<span>'+ widget.target.name +'</span>'));
    td = $('<span>'+ widget.target.name +'</span>');
    //td1 = $('<td>').attr({hidden:true}).append($('<img>').attr({
    td1 = $('<img>').attr({
            src:'{{=URL(c='static',f='images', args='delete.png')}}',
            class:'tags-add',
            hidden:true,
            id: widget.target.id,
            name: widget.target.name,
        });

    $(widget.target).parent().fadeOut(function() { 
        $(this).remove();
        $('#msg_attachment_tags').val('').keyup(); 
    });
    $('#tr-tags-new').append($('<td class=top-td>').append(td,td1));

    selected = $('img.tags-add');
    str = '';
    for(i= 0 ; i < selected.size(); i++){
        str = str + selected[i].id.split('t')[1] + ',';
    }
    
    $(':input[name=tags_new]').val(str);

    $('.top-td').live('mouseenter', function(){
        $($(this).children()[1]).show();
    }).mouseleave(function(){
        $($(this).children()[1]).hide();
    });
    $('.tags-add').one('click', function(){
                id = parseInt(this.id.split('t')[1]);
                tag = {id:id, name:this.name};
                tags.push(tag);
                $(this).parent().parent().fadeOut();
                selected = $('img.tags-add');
                str = '';
                for(i= 0 ; i < selected.size(); i++){
                    str = str + selected[i].id.split('t')[1] + ',';
                }
                $(':input[name=tags_new]').val(str);
    });
}
function showtags()
{
    var text = $(':input[name=tags]').val().toLowerCase();
    var pattern = new RegExp('^.*' + text + '.*$', 'g');

    $('#new-tags').children().remove();
    if(text != ''){
        for(i = 0; i < tags.length; i++){
            if (tags[i].name.match(pattern)) 
            {
                $('#new-tags').append($('<div>').attr({ 
                      class: 'tags',
                      id: 'tag-'+tags[i].id,
                    }).append($('<input>').attr({
                         type: 'checkbox',
                         id: 't' + tags[i].id,
                         name: tags[i].name,
                       })).append($('<label>').text(tags[i].name)));
                  $('#t'+tags[i].id).one('click', addtags);                  
             }
        }
    }
}
 
</script>
