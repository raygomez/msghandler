{{extend 'layout.html'}}
<style type="text/css">
table, td, th {border: 1px solid black;}
table{width: 100%;}
input[type=text]{width: 98%;}
td:last-child {text-align:center;}
select {width:160px;}
button{vertical-align:middle;}
</style>

<script>
$(function() {

    $('[name^=s_]').keyup(function(){
        $(this).change()
    });

    $('[name^=s_]').change(function(){
    
        list = $('#list').find('tr:not(#add-row)').has('td');
        var text1 = $('input[name=s_name]').val().toLowerCase();
        if (text1 != '') var pattern1 = new RegExp('^.*' + text1 + '.*$', 'ig');
        else var pattern1 = new RegExp('.*', 'ig');

        text2 =  $('select[name=s_user_id]').val()
        text3 =  $('select[name=s_contact_type]').val()
        
        var text4 = $('input[name=s_contact_info]').val().toLowerCase();
        if (text4 != '') var pattern4 = new RegExp('^.*' + text4 + '.*$', 'ig');
        else var pattern4 = new RegExp('.*', 'ig');

        $.each(list, function(index,value){
            if(text2 == '') value2 = true
            else {
                if ($(this).find('select').first().val() == text2) value2 = true 
                else value2 = false
            }
            if(text3 == '') value3 = true
            else {
                if ($(this).find('select').eq(1).val() == text3) value3 = true
                else value3 = false
            }
            
            if ($(this).find('input').first().val().match(pattern1) && value2 && value3 &&
                $(this).find('input').eq(1).val().match(pattern4)
            ) 
                $(this).show() 
            else $(this).hide()        
        })
    })
    $('[name=user_id]').live('keyup', function(){
        $(this).change()
    })
    
    $('[name=user_id]').live('change', function(){
        input = $(this).parent().siblings().first().find('input')
        if($(this).val() == '') {
            name = ''
            input.removeAttr('disabled');
        } else {
            input.attr('disabled','disabled');
            name = $(this).children('"[value='+$(this).val()+']"').text()
        }
        input.val(name)
    })

    $('#add-contact').live('click', function(){
        name = $('input[name=name]').val()
        user_id = $('select[name=user_id]').first().val()
        contact_type = $('select[name=contact_type]').first().val()
        contact_info = $('input[name=contact_info]').val()
        if(name =='') {alert('Name should not be blank.'); return }
        if(contact_type==''){alert('Select contact type.'); return }
        if(contact_info==''){alert('Contact info should not be blank.'); return }
        
        $.ajax({
            url:'{{=URL('add_contact')}}',
            data:'name='+name+'&'+'user_id='+user_id+'&'+'contact_type='+contact_type+'&'+'contact_info='+contact_info,
            success: function(data){
                msg = 'Contact is successfully added.'
                name = $('input[name=name]').val()
                user_id = $('select[name=user_id]').first().val()
                contact_type = $('select[name=contact_type]').first().val()
                contact_info = $('input[name=contact_info]').val()
{{options=[OPTION(user.first_name+' '+user.last_name, _value=user.id) for user in users]}}

{{if auth.has_membership('Admin'):}}
    $('#add-row').after('<tr><td><input type="text" value="'+name+'"></td><td>{{=SELECT(options, _name='user_id')}}</td><td>{{=SELECT('mobile','landline','email', _name='contact_type')}}</td><td><input type="text" value="'+contact_info+'"></td><td><a class="update-row" name="'+data+'">Update</a> | <a class="del-row" name="'+data+'">Delete</a></td></tr>')                        
{{else:}}
    $('#add-row').after('<tr><td><input type="text" value="'+name+'"></td><td>{{=SELECT(options, _name='user_id')}}</td><td>{{=SELECT('mobile','landline','email', _name='contact_type')}}</td><td><input type="text" value="'+contact_info+'"></td><td><a class="update-row" name="'+data+'">Update</a></td></tr>')                        
{{pass}}                    
                $('select[name=user_id]').eq(1).val(user_id)
                $('select[name=contact_type]').eq(1).val(contact_type)

                $('input[name=name]').val('')
                $('select[name=user_id]').first().val('')
                $('select[name=contact_type]').first().val('')
                $('input[name=contact_info]').val('')
            
                $('.flash').html(msg).slideDown(function(){ $('.flash').delay(3000).fadeOut(function(){$('.flash').html('')});});
            }
        })        
    })

    $('.update-row').live('click',function(){
        tr = $(this).parent().parent().children()
        name = tr.first().children().first().val()
        user_id = tr.eq(1).children().first().val()
        contact_type = tr.eq(2).children().first().val()
        contact_info = tr.eq(3).children().first().val()

        if(name =='') {alert('Name should not be blank.'); return }
        if(contact_info==''){alert('Contact info should not be blank.'); return }

        $.ajax({
            url: '{{=URL('update_contact')}}',
            data: 'id='+this.name+'&'+'name='+name+'&'+'user_id='+user_id+'&'+'contact_type='+contact_type+'&'+'contact_info='+contact_info,
            context: $(this).parent().parent(),
            success: function(data){
                msg = 'Contact is successfully updated.'
                $('.flash').html(msg).slideDown(function(){ $('.flash').delay(3000).fadeOut(function(){$('.flash').html('')});});
            }
        })        
    })
{{if auth.has_membership('Admin'):}}    
    $('.del-row').live('click', function(){
        var answer = confirm('Are you sure you want to delete this?')
        if (answer){
            $.ajax({
                url: '{{=URL('del_contact')}}',
                data: 'id=' + this.name,
                context: this,
                success: function(data){
                    msg = 'The contact has been successfully deleted.'
                    $(this).parent().parent().fadeOut(1000, function(){ $(this).remove()})
                    $('.flash').html(msg).slideDown(function(){ $('.flash').delay(500).fadeOut(function(){$('.flash').html('')});});
                }                
            })        
        }     
    })
{{pass}}    
});
</script>

Things to Do
<ol>
<li>default values to help user on what to do. <a href="http://webdeveloper.beforeseven.com/jquery/default-text-field-value-disappears-focus">code here</a> used <a href="http://blog.pauljamescampbell.co.uk/about-2/default-value/">this</a> instead</li>
<li>css color problems for default values</li>
<li>fix event on adding/deleting contact info. event reflected is the actual user (added/deleted), not the contact detail.</li>
</ol>
<br/>
<table>
{{options=[OPTION(user.first_name+' '+user.last_name, _value=user.id) for user in users]}}
{{options.insert(0, OPTION('search by user', _value=''))}}
{{types=[OPTION(type, _value=type) for type in ['mobile','landline','email']]}}
{{types.insert(0, OPTION('search by contact type', _value=''))}}

{{=TR(LABEL('Search: '),
      TD(INPUT(_name='s_name', _placeholder='search by name')), \
      TD(SELECT(options, _name='s_user_id')),
      TD(SELECT(types, _name='s_contact_type')), \
      TD(INPUT(_name='s_contact_info', _placeholder='search by contact info')), \      
      TD(TAG.BUTTON('Clear fields', _onclick="$('[name^=s_]').val('');$('[name^=s_]').change()"), _width='14%'))}}
</table>
<br/>
<table id='list'>
{{=TR(TH('Name'), TH('User'), TH('Contact type'), TH('Contact Info', _colspan=2))}}
{{options=[OPTION(user.first_name+' '+user.last_name, _value=user.id) for user in users]}}
{{options.insert(0, OPTION('Select User', _value=''))}}
{{types=[OPTION(type, _value=type) for type in ['mobile','landline','email']]}}
{{types.insert(0, OPTION('Select Contact Type', _value=''))}}

{{=TR(TD(INPUT(_name='name', _placeholder='Name')), \
      TD(SELECT(options, _name='user_id')),
      TD(SELECT(types, _name='contact_type')), \
      TD(INPUT(_name='contact_info', _placeholder='Contact Info')), \      
      TD(A('Add', _id='add-contact')), _id='add-row')}}
{{options.pop(0)}}
{{options.insert(0, OPTION('None', _value=''))}}
{{for contact in contacts:}}
<tr>
{{if contact.user_id:}}
    {{=TD(INPUT(_value=contact.name, _disabled='disabled'))}}
    {{=TD(SELECT(options, value=contact.user_id.id, _name='user_id'))}}
{{else:}}
    {{=TD(INPUT(_value=contact.name))}}
    {{=TD(SELECT(options, value='', _name='user_id'))}}
{{pass}}
{{=TD(SELECT('mobile','landline','email', value=contact.contact_type, _name='contact_type'))}}

{{=TD(INPUT(_value=contact.contact_info))}}
{{if auth.has_membership('Admin'):}}
{{=TD(A('Update', _name=contact.id, _class='update-row'),' | ',A('Delete',  _name=contact.id, _class='del-row'))}}
{{else:}}
{{=TD(A('Update', _name=contact.id, _class='update-row'))}}
{{pass}}
</tr>
{{pass}}
</table>
