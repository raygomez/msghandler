{{extend 'layout.html'}}
<script type="text/javascript" src="/{{=request.application}}/static/js/ui/jquery.ui.core.js"></script> 
<script type="text/javascript" src="/{{=request.application}}/static/js/date.format.js"></script> 
<script type="text/javascript" src="/{{=request.application}}/static/js/ui/jquery.ui.widget.js"></script> 
<script type="text/javascript" src="/{{=request.application}}/static/js/ui/jquery.ui.tabs.js"></script> 

<link rel="stylesheet" href="/{{=request.application}}/static/js/themes/base/jquery.ui.all.css"> 
<style type="text/css"> 
    
/* Vertical Tabs
----------------------------------*/
/*.ui-tabs-vertical { width: 55em; } */

.ui-tabs-vertical .ui-tabs-nav { padding: .2em .1em .2em .2em; float: left; width: 8em; }
.ui-tabs-vertical .ui-tabs-nav li { clear: left; width: 100%; border-bottom-width: 1px !important; border-right-width: 0 !important; margin: 0 -1px .2em 0; }
.ui-tabs-vertical .ui-tabs-nav li a { display:block; }
.ui-tabs-vertical .ui-tabs-nav li.ui-tabs-selected { padding-bottom: 0; padding-right: .1em; border-right-width: 1px; border-right-width: 1px; }
.ui-tabs-vertical .ui-tabs-panel { padding: 0em; float: right;}

    </style> 

<script>

dateFmatter = function(el, cellval, opts){
    //check if this year;
    today = new Date();
    date = new Date(el);
    if (today.getFullYear() == date.getFullYear()){
        if(today.getMonth() ==  date.getMonth() && (today.getDate() == date.getDate())){
            return dateFormat(el, 'shortTime');    
        }
        return dateFormat(el, "mmm d");
    }
    return dateFormat(el, "shortDate");
}  

var lastsel;

$(function(){

    $('img.delete').one('click', function(){
        var answer = confirm('Are you sure you want to delete this?')
        if (answer){
            $(this).parent().fadeOut( function() { $(this).remove();});
            $.ajax({
                url: '{{=URL('delete_ajax_id')}}',
                data: 'id=' + this.id,
                success: function(msg){
                    $('.flash').html(msg).slideDown(function(){ $('.flash').delay(3000).fadeOut(function(){$('.flash').html('')});});
                }                
            })             
        } 
    })
    $('.top-td').live('mouseenter', function(){$($(this).children()[1]).show();})
    $('.top-td').live('mouseleave', function(){$($(this).children()[1]).hide();});
    
    $("#tabs").tabs().addClass('ui-tabs-vertical ui-helper-clearfix');
    $("#tabs li").removeClass('ui-corner-top').addClass('ui-corner-left');
    $('#tabs-late').width($('#tabs-late').parent().width() - $($('#tabs-late').parent().children()[0]).width() - 5);

jQuery("#list").jqGrid({
    url:'{{=URL(r=request,f='call',args=['json','get_rows'])}}',
    data: "{}",
    datatype: "json",
    autoheight: true,
    autowidth: true,
    mtype: 'GET',
    contentType: "application/json; charset=utf-8",
    complete: function(jsondata, stat) {
        if (stat == "success") {
            var thegrid = jQuery("#list")[0];
            thegrid.addJSONData(JSON.parse(jsondata.responseText).d);
        }
    },    
    colNames:['Id', 'Created_by', 'Subject', 'Content' ,'Create_time'],
    colModel :[ 
      {name:'id', index:'id', hidden:true},
      {name:'subject', index:'subject'}, 
      {name:'content', index:'content', hidden:true},       
      {name:'created_by', index:'created_by'}, 
      {name:'create_time', index:'create_time', formatter:dateFmatter}  
    ],
    pager: '#pager',
    rowNum:10,
    rowList:[10,20,30],
    sortname: 'create_time',
    sortorder: 'desc',
    viewrecords: true,
    scrollOffset: '1',
    onSelectRow: function(id){
        alert(id);
        if(id && id!==lastsel){
            jQuery('#list').jqGrid('restoreRow',lastsel);
            jQuery('#list').jqGrid('editRow',id,true);
            lastsel=id;
        }
    },    
    
  }); 
});     

</script>

<div id="tabs">
    <ul> 
        <li><a href="#tabs-late">Late</a></li> 
        <li><a href="#tabs-inbox">Inbox</a></li> 
        <li><a href="#tabs-drafts">Drafts</a></li> 
        <li><a href="#tabs-sent">Sent</a></li> 
        <li><a href="#tabs-trash">Trash</a></li> 
    </ul>
    <div id="tabs-late">
        <table id="list"></table>
    </div>
    <div id="tabs-inbox"> 
<h2>Content heading 1</h2> 
        <p>Proin elit arcu, rutrum commodo, vehicula tempus, commodo a, risus. Curabitur nec arcu. Donec sollicitudin mi sit amet mauris. Nam elementum quam ullamcorper ante. Etiam aliquet massa et lorem. Mauris dapibus lacus auctor risus. Aenean tempor ullamcorper leo. Vivamus sed magna quis ligula eleifend adipiscing. Duis orci. Aliquam sodales tortor vitae ipsum. Aliquam nulla. Duis aliquam molestie erat. Ut et mauris vel pede varius sollicitudin. Sed ut dolor nec orci tincidunt interdum. Phasellus ipsum. Nunc tristique tempus lectus.</p>     
    </div> 
    <div id="tabs-drafts"> 
    <table id="list5"></table>
    </div> 
    <div id="tabs-sent"> 
    </div> 
    <div id="tabs-trash"> 
    </div> 
</div> 

<h1>My Groups</h1>
{{if len(my_roles):}}
{{groups_dict = dict()}}
<ul>{{for role in my_roles:}}
        {{=LI(role.group_id.role)}}
        {{groups_dict[role.group_id.role] = []}}
    {{pass}}
</ul>
{{else:}}{{=I('You have no groups.')}}{{pass}}

<h1>Users</h1>
{{if len(users):}}
[{{=A('Create a new user', _href=URL('create_user'))}}]<br />
<ul>{{for user in users:}}
        {{if isAdmin:}}
            {{=LI(A(user.first_name + ' ' +user.last_name, _href=URL('show_user',args=user.id)),
                IMG(_src=URL('static', 'images/delete.png'), _class='delete', _hidden='true', _id='auth_user-' + `user.id`), _class='top-td' )}}
        {{else:}}
            {{=LI(A(user.first_name + ' ' +user.last_name, _href=URL('show_user',args=user.id)))}}
        {{pass}}
    {{pass}}
</ul>
{{else:}}{{=I('There are no users.')}}{{pass}}

{{if isAdmin or isTelehealth:}}
<h1>Contacts</h1>
{{if len(contacts):}}
[{{=A('Create a new contact', _href=URL('data', args=('create', 'contact')))}}]<br />
<ul>{{for contact in contacts:}}
        {{if isAdmin:}}
            {{=LI(A(contact.name, _href=URL('data', args=('update', 'contact', contact.id))), 
                IMG(_src=URL('static', 'images/delete.png'), _class='delete', _hidden='true', _id='contact-' + `contact.id`), _class='top-td' )}}
        {{else:}}
            {{=LI(A(contact.name, _href=URL('data', args=('update', 'contact', contact.id))))}}
        {{pass}}
    {{pass}}
</ul>
{{else:}}{{=I('There are no contacts.')}}{{pass}}
{{pass}}

{{if len(groups):}}
<h1>Groups</h1>
[{{=A('Create a new group', _href=URL('data', args=('create','auth_group')))}}]<br />
<ul>{{for group in groups:}}
        {{if isAdmin:}}
        {{=LI(A(group.role, _href=URL('data', args=('update', 'auth_group', group.id))),
            IMG(_src=URL('static', 'images/delete.png'), _class='delete', _hidden='true', _id='auth_group-' + `group.id`), _class='top-td' )}}
        {{else:}}{{=LI(A(group.role, _href=URL('data', args=('update', 'auth_group', group.id))))}}
        {{pass}}
    {{pass}}
</ul>
{{pass}}

{{if isAdmin or isTelehealth:}}
<h1>Tags</h1>
{{if len(tags):}}
{{if isAdmin:}}
[{{=A('Create a new tag', _href=URL('data', args=('create', 'tag')))}}]<br />{{pass}}
<ul>{{for tag in tags:}}
        {{if isAdmin:}}
            {{=LI(A(tag.name, _href=URL('data', args=('update', 'tag', tag.id))),
                IMG(_src=URL('static', 'images/delete.png'), _class='delete', _hidden='true', _id='tag-' + `tag.id`), _class='top-td' )}}
        {{else:}}{{=LI(tag.name)}}
        {{pass}}
    {{pass}}
</ul>
{{else:}}{{=I('There are no tags.')}}{{pass}}
{{pass}}

<h1>Messages</h1>
{{created = []}}
{{ungrouped = []}}
{{assigned = []}}
{{grouped = []}}
[{{=A('Create a new message', _href=URL('create_message'))}}]<br />
{{if len(messages):}}
<ul>{{for message in messages:}}
        {{if isAdmin:}}
            {{li=LI(SPAN(A(message.subject, _href=URL('show_message',args=message.id)), ' by ', A(message.created_by.name, _href=URL('show_contact', args=message.created_by.id))),IMG(_src=URL('static', 'images/delete.png'), _class='delete', _hidden='true', _id='msg-' + `message.id`), _class='top-td')}}
            {{if message.created_by == contact_id:}}{{created.append(li)}}
            {{pass}}
            {{if len(msg_group.find(lambda row: row.assigned_by == auth.user.id and row.msg_id == message.id)):}}            
                {{assigned.append(li)}}
            {{elif len(msg_group.find(lambda row: row.msg_id == message.id)) == 0:}}                
                {{ungrouped.append(li)}}            
            {{else:}}{{grouped.append(li)}}            
            {{pass}}            
        {{elif isTelehealth:}}
            {{if message.created_by == contact_id:}}                
                {{li = LI(SPAN(A(message.subject, _href=URL('show_message',args=message.id)), ' by ', A(message.created_by.name, _href=URL('show_contact', args=message.created_by.id))),IMG(_src=URL('static', 'images/delete.png'), _class='delete', _hidden='true', _id='msg-' + `message.id`), _class='top-td')}}
                {{created.append(li)}}
            {{pass}}
            {{if len(msg_group.find(lambda row: row.assigned_by == auth.user.id and row.msg_id == message.id)):}}                        
                {{li =LI(SPAN(A(message.subject, _href=URL('show_message',args=message.id)), ' by ', A(message.created_by.name, _href=URL('show_contact', args=message.created_by.id))), _class='top-td')}}
                {{assigned.append(li)}}                
            {{else:}}  
                {{li =LI(SPAN(A(message.subject, _href=URL('show_message',args=message.id)), ' by ', A(message.created_by.name, _href=URL('show_contact', args=message.created_by.id))), _class='top-td')}}
                {{ungrouped.append(li)}}            
            {{pass}}
        {{else:}}
            {{if message.created_by == contact_id:}}                
                {{li = LI(SPAN(A(message.subject, _href=URL('show_message',args=message.id)), ' by ', A(message.created_by.name, _href=URL('show_contact', args=message.created_by.id))),IMG(_src=URL('static', 'images/delete.png'), _class='delete', _hidden='true', _id='msg-' + `message.id`), _class='top-td')}}
                {{created.append(li)}}
            {{pass}}
            {{group_msgs = msg_group.find(lambda row: row.msg_id == message.id)}}
            {{for msg in group_msgs:}}
                {{li =LI(SPAN(A(message.subject, _href=URL('show_message',args=message.id)), ' by ', A(message.created_by.name, _href=URL('show_contact', args=message.created_by.id))), _class='top-td')}}
                {{groups_dict[msg.group_id.role].append(li)}}            
            {{pass}}

        {{pass}}
    {{pass}}
    
    {{if len(created):}}
        <li><h4>Messages you created</h4></li>
        {{=UL(*created)}}        
    {{pass}}
    {{if len(assigned):}}
        <li><h4>Messages that you have assigned</h4></li>
        {{=UL(*assigned)}}        
    {{pass}}
    
    {{if len(ungrouped):}}
        <li><h4>Messages that have no groups</h4></li>
        {{=UL(*ungrouped)}}        
    {{pass}}

    {{if isAdmin or isTelehealth:}}
        {{if len(grouped):}}
            <li><h4>Messages that have groups</h4></li>
            {{=UL(*grouped)}}        
        {{pass}}
    {{else:}}
        {{for key in groups_dict.keys():}}
            <li><h4>{{=key}}</h4></li>
            {{=UL(*groups_dict[key])}}
        {{pass}}
    {{pass}}
</ul>
{{else:}}{{=I('There are no messages.')}}{{pass}}
